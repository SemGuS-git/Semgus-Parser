/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn more about Gradle by exploring our samples at https://docs.gradle.org/6.8.1/samples
 */

apply plugin: 'java'
apply plugin: 'antlr'
apply plugin: 'eclipse'

repositories {
    mavenCentral()
}

dependencies {
    antlr "org.antlr:antlr4:4.9.1"
    testImplementation "org.junit.jupiter:junit-jupiter-api:5.7.1", "org.junit.jupiter:junit-jupiter-params:5.7.0"
    testRuntimeOnly "org.junit.jupiter:junit-jupiter-engine:5.7.1"
}

test {
    useJUnitPlatform()
}

task copyGrammarFile(type: Copy) {
    from file("${projectDir}/Semgus.g4");
    into file("${projectDir}/src/main/antlr/");
}
generateGrammarSource.dependsOn(copyGrammarFile);

task parseVerificationTests() {
    file('tests').eachFile { testfile ->
        def task = tasks.create(
            [
                name: "parseTest~${testfile.name}",
                type: JavaExec
            ],
            {
                classpath = sourceSets.main.runtimeClasspath
                classpath += configurations.antlr

                main = 'org.antlr.v4.gui.TestRig';
                args = [
                    'Semgus',
                    'start',
                    testfile.absolutePath
                ];
            }
        )
        task.dependsOn(assemble);
        parseVerificationTests.dependsOn(task);
    }
}

check.dependsOn parseVerificationTests
