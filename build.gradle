/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn more about Gradle by exploring our samples at https://docs.gradle.org/6.8.1/samples
 */

apply plugin: 'java'
apply plugin: 'antlr'
apply plugin: 'eclipse'

repositories {
    mavenCentral()
}

dependencies {
    antlr "org.antlr:antlr4:4.9.1"
    testImplementation "org.junit.jupiter:junit-jupiter-api:5.7.1", "org.junit.jupiter:junit-jupiter-params:5.7.0"
    testRuntimeOnly "org.junit.jupiter:junit-jupiter-engine:5.7.1"
}

test {
    useJUnitPlatform()
}

/*
 Handles copying the Semgus grammar file from the root to where Gradle expects it.
 The Semgus.g4 file is the main artifact of this repository, so no need to bury it.
*/
task copyGrammarFile(type: Copy) {
    from file("${projectDir}/Semgus.g4");
    into file("${projectDir}/src/main/antlr/");
}
generateGrammarSource.dependsOn(copyGrammarFile);

/*
 Quick-n-dirty automated testing. Creates tasks for each file in the tests/ directory
 and automatically calls the ANTLR test rig on them to see any parse errors. Eventually
 this should be replaced with "real" testing using JUnit or similar.
*/
task parseVerificationTests() {
    file('tests').eachFile { testfile ->
        def task = tasks.create(
            [
                name: "parseTest~${testfile.name}",
                type: JavaExec
            ],
            {
                classpath = sourceSets.main.runtimeClasspath
                classpath += configurations.antlr

                main = 'org.antlr.v4.gui.TestRig';
                args = [
                    'Semgus',
                    'start',
                    testfile.absolutePath
                ];
            }
        )
        task.dependsOn(assemble);
        parseVerificationTests.dependsOn(task);
    }
}
check.dependsOn parseVerificationTests

/*
 Convenience task for running the ANTLR GUI test rig.
 Pass a filename with -Pfilename=<filename> on the command line.
*/
task checkGuiTree(type: JavaExec) {
    classpath = sourceSets.main.runtimeClasspath
    classpath += configurations.antlr

    main = 'org.antlr.v4.gui.TestRig';
    args = [
        'Semgus',
        'start',
        '-gui',
        findProperty('filename') ?: "" // Required for Gradle configuration to work
    ];
    doFirst {
        if (!findProperty('filename')) {
            throw new InvalidUserDataException("A filename is required. Pass -Pfilename=<filename> to Gradle.");
        }
    }
}
checkGuiTree.dependsOn(build)
